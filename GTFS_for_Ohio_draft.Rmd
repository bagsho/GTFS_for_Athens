---
title: "GTFS Creation for GoBus Service in OHIO"
author: "Orhan Aktas"
date: '2022-11-02'
output:   
    html_document:
      toc: yes
      number_sections: yes
      toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source = "bg-warning text-warning"
)
```

```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(tidytransit)
library(jsonlite)
library(printr)
library(hms)
library(lubridate)
library(readxl)
source("functions.R")
library(rvest)
library(tidygeocoder)
```

# Introduction

In this document, a validated, frequency-based GTFS feed for Athens, Ohio is created from the current informal transit network files. The final output GTFS feed includes the following files that have the required fields.

-   agency.txt

-   stops.txt

-   routes.txt

-   trips.txt

-   stop_times.txt

-   calendar.txt

-   frequencies.txt

-   shapes.txt

# Import data

## Sample GTFS data format

This feed is a collection of sample data files that are published by Google.

```{r import sample_GTFS, message=FALSE, warning=FALSE}
sample_GTFS <- read_gtfs("data/sample-feed.zip")
```

## Input File

This feed was created manually at the beginning of the project.

```{r import input_file, message=FALSE, warning=FALSE}
input_stops <- read_excel("data/ohio/input_file.xlsx",sheet = "stops")
input_routes <- read_excel("data/ohio/input_file.xlsx",sheet = "routes")
```


# Create GTFS feed

## create agency

```{r}
final_agency<-sample_GTFS %>%
    pluck("agency") %>%
    slice(0) %>% 
    add_row(agency_id="GOBUS",
            agency_name="GoBus Intercity Bus Service",
            agency_url="https://ridegobus.com/",
            agency_timezone="US/Eastern"
    )

final_agency
```

## create calendar

```{r calendar}
final_calendar<-sample_GTFS %>%
    pluck("calendar") %>%
    slice(0) %>%
    mutate(start_date=as.double(start_date),
           end_date=as.double(end_date)
    ) %>% 
    add_row(service_id="AllDays",
          monday=1,
          tuesday=1,
          wednesday=1,
          thursday=1,
          friday=1,
          saturday=1,
          sunday=1,
          start_date=as.double(20220101),
          end_date=as.double(20251231) 
    )

final_calendar
```

## create shapes

```{r shapes}
final_shapes <- sample_GTFS %>%
  pluck("shapes") %>%
  slice(0) %>%
  select(-shape_dist_traveled)

input_shapes <- input_routes |>
mutate(shape_id = paste0(line, "_", direction)) |>
select(shape_id, latitude, longitude, order) |> 
mutate(order=order-1) |> 
rename(shape_pt_lat=latitude,
       shape_pt_lon=longitude,
       shape_pt_sequence=order)

final_shapes <- final_shapes |> bind_rows(input_shapes)

final_shapes %>% view
```