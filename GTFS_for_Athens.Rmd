---
title: "GTFS Creation for Mexico City Transit System"
author: "Orhan Aktas"
date: '2022-02-24'
output:   
    html_document:
      toc: yes
      number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source = "bg-warning text-warning"
)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidytransit)
library(printr)
library(sf)
library(hms)
library(lubridate)
library(units)
library(zip)
```

# Introduction

In this document, a validated, frequency-based GTFS feed for Mexico City is created from the current informal transit network files. The final output GTFS feed includes the following files that have the required fields.

-   agency.txt

-   stops.txt

-   routes.txt

-   trips.txt

-   stop_times.txt

-   calendar.txt

-   frequencies.txt

-   shapes.txt

Because of the assumptions made for the creation of this GTFS file system, some tables have same number of rows. For instances, since there isn't any headway change during the day, trips table and frequencies table have same number of rows, latter showing the headways of the trips they follow all day. Another pair is the stops table and the stop_times table. They have equal number of rows because both of them list the sequence of stops along each trip.

These files have relations based on key variables. Although there have been a lot of variables, four of them are critical.route_id, trip_id, shape_id and stop_id. Since there isn't a specified naming for these id's, they are coded as follows: Routes have their route_id's based on their order of the route table. Trips are named for each direction of the routes. If a route is two-way, then it has two trips, each of both is opposite of each other. Since there are no change in the paths of the routes during the day (at least in this data) shape_id's are same with trip id's. Lastly, the stop_id's are just the stop sequence added trip_id's (shape_id's) since all the stops are in a way route specific. All of these four key variables are some combinations of route, direction and stop sequences. Below there is a table that summarizes them.

| No  | Name     | Contents                                    |
|-----|----------|---------------------------------------------|
| 1   | route_id | [route_id]                                  |
| 2   | trip_id  | [route_id] \_ [direction]                   |
| 3   | shape_id | [route_id] \_ [direction]                   |
| 4   | stop_id  | [route_id] \_ [direction] \_ [stopSequence] |

Lastly there are some parameters that have been used in this study. They are required in various steps while creating different files. while direction information is used while creating the trips from routes, agency and route-based headways are required for the frequencies table. Also, stops of a considerable number of the routes are created based on the stop density information and finally, speeds for different agencies are used in calculating the stop_times. These parameters are summarized in the table below.

![](data/parameters.jpg)

# Import data

## Current GTFS data format

import

```{r import current_GTFS, message=FALSE, warning=FALSE}
current_GTFS <- read_gtfs("data/gtfs_20211027.zip")
names(current_GTFS)
```

A validation result table shows the files and fields in the GTFS feed and how they compare to the specification. This table not only shows the files and fields in the table, but the whole possible file and fields of a ideal GTFS feed. That way it enables the analyst to identify the current situation better. To investigate all the files in detail, all rows of the table are shown below.

```{r investigate current_GTFS, message=FALSE, warning=FALSE}
validation_result <- attr(current_GTFS, "validation_result")
validation_result
validation_result %>%
  group_by(file_spec, file, file_provided_status) %>%
  summarise(count = n())
validation_result %>%
  group_by(file_spec, file_provided_status, field_spec, field_provided_status) %>%
  summarise(count = n())
```

Since there is not any required file or field is missing, it is concluded that the GTFS file is valid.

A quick look at the comparison of the feed with the specifications.

```{r comp with specs, message=FALSE, warning=FALSE}
validation_result %>%
  group_by(file_spec, file, file_provided_status) %>%
  summarise(count = n()) %>%
  arrange(desc(file_spec), desc(file_provided_status)) %>%
  select(file_spec, file_provided_status, file)
```

A final look at the feed to conclude the section.

```{r comp with specs2, message=FALSE, warning=FALSE}
validation_result %>%
  group_by(file_spec, file, file_provided_status) %>%
  summarise(count = n()) %>%
  arrange(desc(file_spec), desc(file_provided_status)) %>%
  select(file_spec, file_provided_status, file) %>%
  group_by(file_spec, file_provided_status) %>%
  summarise(count = n()) %>%
  arrange(desc(file_spec), desc(file_provided_status))
```

There are 6 required files in the specifications that are all included in the current GTFS feed. On the other hand, there 11 optional files in the specifications while only two of them are included in the feed.

## Mapaton

import

```{r import mapaton, message=FALSE, warning=FALSE}
mapaton <- st_read("data/mapaton") %>%
  mutate(RouteID = row_number())
mapaton %>% head()
mapaton %>% str()
mapaton %>% glimpse()
```

analyse

```{r analyse mapaton, message=FALSE, warning=FALSE}
mapaton %>%
  select(Tipo_vehic) %>%
  as_tibble() %>%
  group_by(Tipo_vehic) %>%
  summarise(count = n())
mapaton %>%
  select(kms_hora) %>%
  as_tibble() %>%
  group_by(kms_hora) %>%
  summarise(count = n()) %>%
  ggplot(aes(kms_hora, count)) +
  geom_col()
```

proof of kms_hora=speed

```{r speed proof mapaton, message=FALSE, warning=FALSE}
mapaton %>%
  select(Long_kms, minutos_vi, kms_hora) %>%
  mutate(speed = Long_kms / minutos_vi * 60) %>%
  head()
```

## Mexibus

mexibus_line1

```{r mexibus_line1, message=FALSE, warning=FALSE}
# import
mexibus_line1_imported <- st_read("data/mexibus/Mexibús Línea 1.kml")
# separate route and stops
mexibus_line1_stops <- mexibus_line1_imported %>%
  mutate(Route = first(Description)) %>%
  slice(2:n()) %>%
  select(Name, Route) %>%
  as_tibble()
mexibus_line1_routes <- mexibus_line1_imported %>%
  slice(1L) %>%
  mutate(Name = Description) %>%
  select(-Description) %>%
  as_tibble()
# create a list for line1
mexibus_line1 <- list(routes = mexibus_line1_routes, stops = mexibus_line1_stops)
rm(mexibus_line1_imported, mexibus_line1_stops, mexibus_line1_routes)
```

mexibus_line2

```{r mexibus_line2, message=FALSE, warning=FALSE}
# import
mexibus_line2_imported <- st_read("data/mexibus/Mexibús Línea 2.kml")
# separate route and stops
mexibus_line2_stops <- mexibus_line2_imported %>%
  mutate(Route = first(Description)) %>%
  slice(2:n()) %>%
  select(Name, Route) %>%
  as_tibble()
mexibus_line2_routes <- mexibus_line2_imported %>%
  slice(1L) %>%
  mutate(Name = Description) %>%
  select(-Description) %>%
  as_tibble()
# create a list for line1
mexibus_line2 <- list(routes = mexibus_line2_routes, stops = mexibus_line2_stops)
rm(mexibus_line2_imported, mexibus_line2_stops, mexibus_line2_routes)
```

mexibus_line3

```{r mexibus_line3, message=FALSE, warning=FALSE}
# import
mexibus_line3_imported <- st_read("data/mexibus/Mexibús Línea 3.kml")
# separate route and stops
mexibus_line3_stops <- mexibus_line3_imported %>%
  mutate(Route = first(Description)) %>%
  slice(2:n()) %>%
  select(Name, Route) %>%
  as_tibble()
mexibus_line3_routes <- mexibus_line3_imported %>%
  slice(1L) %>%
  mutate(Name = Description) %>%
  select(-Description) %>%
  as_tibble()
# create a list for line1
mexibus_line3 <- list(routes = mexibus_line3_routes, stops = mexibus_line3_stops)
rm(mexibus_line3_imported, mexibus_line3_stops, mexibus_line3_routes)
```

combine all three lines into one list

```{r combine mexibus lines, message=FALSE, warning=FALSE}
mexibus <- list(line1 = mexibus_line1, line2 = mexibus_line2, line3 = mexibus_line3)
rm(mexibus_line1, mexibus_line2, mexibus_line3)
```

## viaDF

import types

```{r import viaDF types, message=FALSE, warning=FALSE}
types <- read_delim("data/viaDF/types.txt",
  "\t",
  escape_double = FALSE,
  col_names = c("ID", "Name", "Speed"),
  col_types = cols(X4 = col_skip(), X5 = col_skip()),
  locale = locale(decimal_mark = ",", grouping_mark = "."),
  trim_ws = TRUE
) %>%
  filter(ID == 4)
types
```

import routes

```{r import viaDF routes, message=FALSE, warning=FALSE}
routes <- read_delim("data/viaDF/routes.txt",
  "\t",
  escape_double = FALSE,
  col_names = c("ID", "Name", "Status", "SplitRoutePieceID", "FromName", "ToName", "TypeID"),
  trim_ws = TRUE
) %>%
  filter(TypeID == 4) %>%
  mutate(SplitRoutePieceID = as.integer(SplitRoutePieceID))
head(routes)
```

import routepieces

```{r import viaDF routepieces, message=FALSE, warning=FALSE}
routepieces <- read_delim("data/viaDF/routepieces.txt",
  "\t",
  escape_double = FALSE,
  col_names = c("ID", "Name", "Lat", "Lng", "RouteID"),
  locale = locale(decimal_mark = ",", grouping_mark = "."),
  trim_ws = TRUE
) %>%
  mutate(Name = na_if(Name, "NULL")) %>%
  left_join(routes, by = c("RouteID" = "ID")) %>%
  filter(TypeID == 4) %>%
  select(ID, Name = Name.x, Lat, Lng, RouteID, TypeID)


head(routepieces)
```

combine all files into one list

```{r combine viaDF files, message=FALSE, warning=FALSE}
viaDF <- list(types = types, routes = routes, routepieces = routepieces)
rm(types, routes, routepieces)
```

# Creating GTFS files

## Agency

```{r create agency, message=FALSE, warning=FALSE}
agency <- current_GTFS %>%
  pluck("agency") %>%
  slice(1:5) %>%
  mutate(
    agency_id = c("MPT_A", "MPT_M", "MPT_V", "MXBS", "Via_M"),
    agency_name = c("Mapaton Autobus", "Mapaton Microbus", "Mapaton Vagoneta", "Mexibus", "ViaDF Micro"),
    agency_url = ifelse(is.na(agency_url), agency_url, NA)
  )

head(agency)
```

## Calendar

```{r create calendar, message=FALSE, warning=FALSE}
calendar <- current_GTFS %>%
  pluck("calendar") %>%
  slice(1) %>%
  mutate(
    service_id = "1",
    monday = 1,
    tuesday = 1,
    wednesday = 1,
    thursday = 1,
    friday = 1,
    saturday = 0,
    sunday = 0,
    start_date=as.double(20200101),
    end_date  =as.double(20221231)
  )

head(calendar)
```

## Routes

mapaton routes

```{r create routes mapaton, message=FALSE, warning=FALSE}
routes_mapaton <- current_GTFS %>%
  pluck("routes") %>%
  slice(0) %>%
  add_row(route_long_name = mapaton$Nombre, agency_id = mapaton$Tipo_vehic) %>%
  mutate(
    agency_id = recode(agency_id,
      "Autobús" = "MPT_A",
      "Microbús" = "MPT_M",
      "Vagoneta/Combi" = "MPT_V"
    ),
    direction = "two-way"
  )
```

mexibus routes

```{r create routes mexibus, message=FALSE, warning=FALSE}
routes_mexibus <- current_GTFS %>%
  pluck("routes") %>%
  slice(0) %>%
  add_row(route_long_name = mexibus %>% pluck(
    "line1",
    "routes",
    "Name"
  )) %>%
  add_row(route_long_name = mexibus %>% pluck(
    "line2",
    "routes",
    "Name"
  )) %>%
  add_row(route_long_name = mexibus %>% pluck(
    "line3",
    "routes",
    "Name"
  )) %>%
  mutate(
    agency_id = "MXBS",
    direction = "two-way"
  )
```

viaDF routes

```{r create routes viaDF, message=FALSE, warning=FALSE}
routes_viaDF <- current_GTFS %>%
  pluck("routes") %>%
  slice(0) %>%
  add_row(route_long_name = viaDF %>% pluck("routes", "Name")) %>%
  mutate(
    agency_id = "Via_M",
    direction = ifelse(is.na(viaDF %>% pluck("routes", "SplitRoutePieceID")), "one-way", "two-way")
  )
```

combine all files into one route file. This file has a direction field which is deleted at the later stages.

```{r combine route files, message=FALSE, warning=FALSE}
routes <- bind_rows(
  routes_mapaton,
  routes_mexibus,
  routes_viaDF
) %>%
  mutate(route_id = row_number())

rm(routes_mapaton, routes_mexibus, routes_viaDF)

head(routes)
```

## Trips

create initial trips table from routes. Additional rows are added for the routes that are two-ways.

```{r create initial trips table, message=FALSE, warning=FALSE}
# create trips for direction=0
routes_dir0 <- routes %>%
  select(route_id) %>%
  mutate(
    route_id = as.character(route_id),
    direction_id = 0
  )

# create trips for direction=1
routes_dir1 <- routes %>%
  filter(direction == "two-way") %>%
  select(route_id) %>%
  mutate(
    route_id = as.character(route_id),
    direction_id = 1
  )

# combine both trips
trips_initial <- bind_rows(routes_dir0, routes_dir1) %>%
  mutate(trip_id = paste(route_id, direction_id, sep = "_")) %>%
  relocate(trip_id)

rm(routes_dir0, routes_dir1)

trips_initial <- current_GTFS %>%
  pluck("trips") %>%
  slice(0) %>%
  bind_rows(trips_initial) %>%
  mutate(service_id = 1)

head(trips_initial)
```

## Frequencies

create frequencies table from trips table. Headways are taken from the parameters excel sheet.

```{r create frequencies table, message=FALSE, warning=FALSE}
freq_temp <- trips_initial %>%
  select(trip_id, route_id) %>%
  left_join(routes %>%
    select(route_id, agency_id) %>%
    mutate(route_id = as.character(route_id))) %>%
  mutate(headway_secs = case_when(
    agency_id == "MPT_A" ~ 270,
    agency_id == "MPT_M" ~ 480,
    agency_id == "MPT_V" ~ 600,
    agency_id == "MXBS" ~ 180,
    agency_id == "Via_M" ~ 480
  )) %>%
  select(trip_id, headway_secs)

frequencies <- current_GTFS %>%
  pluck("frequencies") %>%
  slice(0) %>%
  add_row(
    trip_id = freq_temp$trip_id,
    headway_secs = freq_temp$headway_secs
  ) %>%
  mutate(
    exact_times = 0,
    start_time = hms::hms(0, 0, 6),
    end_time = hms::hms(59, 59, 23)
  )

rm(freq_temp)

head(frequencies)
```

## Stops & Shapes

Since both stops and shapes files are spatial entities and the process of creating them includes similar sub activities, they are preferred to be done in the same section.

The stops of Mexibus lines are provided within KML files. For the lines under ViaDF - Micro and Mapaton agency_id's, the stops are generated from route path data, based on the stop density parameter which is 165 meters.

The output files include additional columns which are added because they might be needed within the project. They will be not included in the final GTFS file.

### Mexibus

shapes

```{r create mexibus shapes, message=FALSE, warning=FALSE}

# direction 0
mexibus_shapes_dir0 <- map(mexibus, first) %>%
  bind_rows() %>%
  st_as_sf() %>%
  st_coordinates() %>%
  as_tibble() %>%
  group_by(L1) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  select(-Z) %>%
  mutate(dir = 0)

# direction 1
mexibus_shapes_dir1 <- mexibus_shapes_dir0 %>%
  arrange(L1, desc(seq)) %>%
  group_by(L1) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(dir = 1)

# combine both
mexibus_shapes <- bind_rows(mexibus_shapes_dir0, mexibus_shapes_dir1) %>%
  mutate(shape_id = paste(as.character(L1 + 501), "_", as.character(dir), sep = "")) %>%
  mutate(
    shape_dist = 0,
    L1 = L1 + 501
  ) %>%
  select(shape_id,
    shape_pt_lat = Y,
    shape_pt_lon = X,
    shape_pt_sequence = seq,
    shape_dist,
    RouteID = L1
  )

# calculate shape_dist
dist_column <- mexibus_shapes %>%
  st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"), crs = 4326) %>%
  mutate(next_geometry = lead(geometry)) %>%
  mutate(dif = lag(st_distance(geometry, next_geometry, by_element = TRUE))) %>%
  mutate(dif = ifelse(shape_pt_sequence == 1, 0, dif)) %>%
  group_by(shape_id) %>%
  mutate(shape_dist = cumsum(dif))%>% 
  as_tibble() %>% 
  select(shape_dist)

mexibus_shapes <- mexibus_shapes %>% 
  mutate(shape_dist = dist_column$shape_dist)

# check whether it is correctly calculated
mexibus_shapes %>%
  group_by(shape_id) %>%
  summarise(shape_dist = max(shape_dist))

mexibus %>%
  map(pluck("routes")) %>%
  map(st_as_sf) %>%
  map(st_length) %>%
  bind_rows()


rm(mexibus_shapes_dir0, mexibus_shapes_dir1, dist_column)

head(mexibus_shapes)
```

Stops

```{r create mexibus stops, message=FALSE, warning=FALSE}

mexibus_tibble <- map(mexibus, last) %>%
  map(mutate, seq = row_number()) %>%
  bind_rows()


mexibus_tibble <- mexibus_tibble %>%
  mutate(
    stop_lon = unlist(map(mexibus_tibble$geometry, 1)),
    stop_lat = unlist(map(mexibus_tibble$geometry, 2))
  ) %>%
  select(stop_lat, stop_lon, "stop_name" = Name, Route, seq)

# direction 0
mexibus_stops_dir0 <- current_GTFS %>%
  pluck("stops") %>%
  slice(0) %>%
  add_row(
    stop_lat = mexibus_tibble$stop_lat,
    stop_lon = mexibus_tibble$stop_lon,
    stop_name = mexibus_tibble$stop_name
  ) %>%
  mutate(
    route = as.integer(str_sub(mexibus_tibble$Route, 10, 10))+501,
    seq = mexibus_tibble$seq,
    stop_id = paste(as.character(route),  "_0_", as.character(seq), sep = "")
  )

# direction 1
mexibus_stops_dir1 <- mexibus_stops_dir0 %>%
  arrange(route, desc(seq)) %>%
  group_by(route) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(stop_id = paste(as.character(route),  "_1_", as.character(seq), sep = ""))

# combine both
mexibus_stops <- bind_rows(mexibus_stops_dir0, mexibus_stops_dir1) %>% select(-route,-seq)


rm(mexibus_tibble,mexibus_stops_dir0,mexibus_stops_dir1)
head(mexibus_stops)
```

### viaDF

shapes

```{r create viaDF shapes, message=FALSE, warning=FALSE}

# direction 0
viaDF_shapes_dir0 <- viaDF %>%
  pluck("routepieces") %>%
  left_join(viaDF %>% pluck("routes"), by = c("RouteID" = "ID")) %>%
  select(RouteID, ID, SplitRoutePieceID, Lat, Lng) %>%
  filter(ID <= SplitRoutePieceID | is.na(SplitRoutePieceID)) %>%
  group_by(RouteID) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(dir = 0)

# direction 1
viaDF_shapes_dir1 <- viaDF %>%
  pluck("routepieces") %>%
  left_join(viaDF %>% pluck("routes"), by = c("RouteID" = "ID")) %>%
  select(RouteID, ID, SplitRoutePieceID, Lat, Lng) %>%
  filter(ID >= SplitRoutePieceID) %>%
  group_by(RouteID) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(dir = 1)

# combine both
viaDF_shapes <- bind_rows(viaDF_shapes_dir0, viaDF_shapes_dir1) %>%
  left_join(viaDF %>% 
              pluck("routes") %>% 
              select(ID) %>% 
              mutate(route_id = row_number() + 504) %>% 
              rename(correct_id = route_id, old_id = ID), by = c("RouteID" = "old_id")
            ) %>%
  mutate(shape_id = paste(as.character(correct_id), "_", as.character(dir), sep = "")) %>%
  mutate(shape_dist = 0) %>%
  select(shape_id,
    shape_pt_lat = Lat,
    shape_pt_lon = Lng,
    shape_pt_sequence = seq,
    shape_dist,
    RouteID=correct_id
  )

# calculate shape_dist

dist_column<-read_rds("data/viaDF_shape_dist.RDS")

# original calculation lasts for 10 minutes. Therefore it is imported from previously created table. Run the code below to calculate directly from viaDF_shapes

# dist_column <- viaDF_shapes %>%
#   st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"), crs = 4326) %>%
#   mutate(next_geometry = lead(geometry)) %>%
#   mutate(dif = lag(st_distance(geometry, next_geometry, by_element = TRUE))) %>%
#   mutate(dif = ifelse(shape_pt_sequence == 1, 0, dif)) %>%
#   group_by(shape_id) %>%
#   mutate(shape_dist = cumsum(dif))%>%
#   as_tibble() %>%
#   select(shape_dist)

viaDF_shapes <- viaDF_shapes %>%
  mutate(shape_dist = dist_column$shape_dist)

rm(viaDF_shapes_dir0, viaDF_shapes_dir1,dist_column)

head(viaDF_shapes)
```

Stops

They will be assigned onto routes based on the stop density parameter. (every 165 meters)

```{r create viaDF stops, message=FALSE, warning=FALSE}
viaDF_stops_draft <- viaDF_shapes %>%
  st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"), crs = 4326) %>%
  group_by(shape_id) %>%
  summarise(shape_id = first(shape_id), do_union = FALSE) %>%
  st_cast("LINESTRING") %>%
  st_transform(3857) %>%
  st_line_sample(density = 1 / 165) %>%
  st_transform(4326) %>%
  as_tibble() %>%
  bind_cols(viaDF_shapes %>% group_by(shape_id) %>%
    summarise(count = n())) %>%
  select(shape_id, geometry) %>%
  st_as_sf() %>%
  st_cast("POINT")

lon <- viaDF_stops_draft %>%
  pluck(2) %>%
  map(pluck, 1) %>%
  unlist() %>%
  as_tibble()

lat <- viaDF_stops_draft %>%
  pluck(2) %>%
  map(pluck, 2) %>%
  unlist() %>%
  as_tibble()

stop_id <- viaDF_stops_draft %>%
  as_tibble() %>%
  select(shape_id) %>%
  group_by(shape_id) %>%
  mutate(seq = row_number()) %>%
  mutate(stop_id = paste(as.character(shape_id), "_", as.character(seq), sep = "")) %>% 
  ungroup() %>% 
  select (stop_id)

viaDF_stops <- current_GTFS %>%
  pluck("stops") %>%
  slice(0) %>%
  add_row(
    stop_id=stop_id$stop_id,
    stop_lat = lat$value,
    stop_lon = lon$value
  )

rm(viaDF_stops_draft,lon,lat,stop_id)

head(viaDF_stops)
```

### Mapaton

Shapes

```{r create Mapaton shapes, message=FALSE, warning=FALSE}

problematic_routes <-
  mapaton %>%
  st_transform(4326) %>%
  select(Nombre, geometry) %>%
  st_cast("LINESTRING") %>%
  as_tibble() %>%
  group_by(Nombre) %>%
  summarise(count = n()) %>%
  filter(count != 1)

# direction 0
mapaton_shapes_dir0 <- mapaton %>%
  left_join(problematic_routes, by = "Nombre") %>%
  filter(is.na(count)) %>%
  st_transform(4326) %>%
  select(RouteID, geometry) %>%
  st_cast("LINESTRING") %>%
  st_coordinates() %>%
  as_tibble() %>%
  group_by(L1) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(dir = 0)

# direction 1
mapaton_shapes_dir1 <- mapaton_shapes_dir0 %>%
  arrange(L1, desc(seq)) %>%
  group_by(L1) %>%
  mutate(seq = row_number()) %>%
  ungroup() %>%
  mutate(dir = 1)

# Correct RouteID's
CorrectID<-mapaton %>%
    left_join(problematic_routes, by = "Nombre") %>%
    filter(is.na(count)) %>% 
    as_tibble() %>% 
    select(RouteID) %>% 
    rename(correct_id = RouteID) %>% 
    mutate(old_id = row_number())


# combine both
mapaton_shapes <- bind_rows(mapaton_shapes_dir0, mapaton_shapes_dir1) %>%
  left_join(CorrectID,by=c("L1"="old_id")) %>% 
  mutate(shape_id = paste(as.character(correct_id), "_", as.character(dir), sep = "")) %>%
  mutate(shape_dist = 0) %>%
  select(shape_id,
    shape_pt_lat = Y,
    shape_pt_lon = X,
    shape_pt_sequence = seq,
    shape_dist,
    RouteID = correct_id
  )


# calculate shape_dist

dist_column<-read_rds("data/mapaton_shape_dist.RDS")

# original calculation lasts for 10 minutes. Therefore it is imported from previously created table. Run the code below to calculate directly from mapaton_shapes

# dist_column <- mapaton_shapes %>%
#   st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"), crs = 4326) %>%
#   mutate(next_geometry = lead(geometry)) %>%
#   mutate(dif = lag(st_distance(geometry, next_geometry, by_element = TRUE))) %>%
#   mutate(dif = ifelse(shape_pt_sequence == 1, 0, dif)) %>%
#   group_by(shape_id) %>%
#   mutate(shape_dist = cumsum(dif))%>%
#   as_tibble() %>%
#   select(shape_dist)

mapaton_shapes <- mapaton_shapes %>%
  mutate(shape_dist = dist_column$shape_dist)

rm(problematic_routes, mapaton_shapes_dir0, mapaton_shapes_dir1,dist_column,CorrectID)

head(mapaton_shapes)

```

Stops

```{r create Mapaton stops, message=FALSE, warning=FALSE}

mapaton_stops_draft <- mapaton_shapes %>%
  st_as_sf(coords = c("shape_pt_lon", "shape_pt_lat"), crs = 4326) %>%
  group_by(shape_id) %>%
  summarise(shape_id = first(shape_id), do_union = FALSE) %>%
  st_cast("LINESTRING") %>%
  st_transform(3857) %>%
  st_line_sample(density = 1 / 165) %>%
  st_transform(4326) %>%
  as_tibble() %>%
  bind_cols(mapaton_shapes %>% group_by(shape_id) %>%
    summarise(count = n())) %>%
  select(shape_id, geometry) %>%
  st_as_sf() %>%
  st_cast("POINT")


lon <- mapaton_stops_draft %>%
  pluck(2) %>%
  map(pluck, 1) %>%
  unlist() %>%
  as_tibble()

lat <- mapaton_stops_draft %>%
  pluck(2) %>%
  map(pluck, 2) %>%
  unlist() %>%
  as_tibble()
stop_id <- mapaton_stops_draft %>%
  as_tibble() %>%
  select(shape_id) %>%
  group_by(shape_id) %>%
  mutate(seq = row_number()) %>%
  mutate(stop_id = paste(as.character(shape_id), "_", as.character(seq), sep = "")) %>% 
  ungroup() %>% 
  select (stop_id)

mapaton_stops <- current_GTFS %>%
  pluck("stops") %>%
  slice(0) %>%
  add_row(
    stop_id=stop_id$stop_id,
    stop_lat = lat$value,
    stop_lon = lon$value
  )

rm(mapaton_stops_draft,lon,lat,stop_id)

head(mapaton_stops)
```

### Single Output Files

stops

The stop_name field is only available for Mexibus lines since the others are produced automatically.

```{r combine stops files, message=FALSE, warning=FALSE}
stops <- bind_rows(
  mexibus_stops,
  viaDF_stops,
  mapaton_stops
  )
rm(mexibus_stops,viaDF_stops,mapaton_stops)
head(stops)
```

shapes

```{r combine shapes files, message=FALSE, warning=FALSE}
shapes <- bind_rows(
  mexibus_shapes,
  viaDF_shapes,
  mapaton_shapes
  ) %>% 
  select(-RouteID)

rm(mexibus_shapes,viaDF_shapes,mapaton_shapes)

head(shapes)
```

## Stop_times

preperation

```{r preperation for stop_times file, message=FALSE, warning=FALSE}
stop_times_draft<-stops %>%
  select(stop_id) %>%
  mutate(
    trip_id=str_sub(stop_id,1,as.integer(str_locate_all(stop_id,"_")%>% map_chr(., 2))-1),
    route_id=str_sub(stop_id,1,as.integer(str_locate_all(stop_id,"_")%>% map_chr(., 1))-1),
    stop_sequence = as.integer(str_sub(
      stop_id,
      as.integer(str_locate_all(stop_id, "_") %>% map_chr(., 2)) + 1,
      length(stop_id)
      )
    )
  ) %>% 
  left_join(routes %>% 
              mutate(route_id=as.character(route_id)) %>% 
              select(route_id,agency_id),
            by="route_id"
  ) %>% 
  left_join(mapaton%>% 
              mutate(route_id=as.character(RouteID)) %>% 
              select(route_id,speed=kms_hora), # Route-specific speed values for Mapaton lines 
            by="route_id"
  ) %>% 
  as_tibble() %>% 
  select(-geometry)





```

speed entries

```{r speed entries, message=FALSE, warning=FALSE}
stop_times_draft<-
  stop_times_draft %>% mutate(
                          speed=ifelse(route_id=="502",25,speed),
                          speed=ifelse(route_id=="503",22,speed),
                          speed=ifelse(route_id=="504",20,speed),
                          speed=ifelse(agency_id=="Via_M",12.8,speed)
                       )

stop_times_draft %>% 
  mutate(IsSpeedNA=is.na(speed)) %>% 
  group_by(agency_id,IsSpeedNA) %>% 
  summarise(count=n())

stop_times_draft<-stop_times_draft %>% select(-agency_id)
```

calculation of distances and times

```{r calculation of distances, message=FALSE, warning=FALSE}

# original calculation lasted for 25 minutes. Therefore it is imported from previously created table. Run the code below to calculate directly from stops file.

# stop_distances<-stops %>% 
#   select(stop_id,stop_lat,stop_lon) %>% 
#   st_as_sf(coords = c("stop_lon", "stop_lat"), crs = 4326) %>% 
#   mutate(next_geometry=lag(geometry))%>% 
#   mutate(length=st_distance(geometry,next_geometry,by_element = TRUE))


# shortcut to stop distances
stop_times_draft<-
  stop_times_draft %>% 
    bind_cols(
      read_rds( "data/distances_for_stop_times.RDS") %>% select(length))   


stop_times_draft<-stop_times_draft %>%
  mutate(length = drop_units(length)) %>%
  mutate(duration = length / 1000 / speed * 3600) %>%  
  mutate(duration = ifelse(stop_sequence==1,0,duration)) %>% 
  group_by(trip_id) %>% 
  mutate(stop_times=round(cumsum(duration),0)) %>%
  mutate(stop_times=hms::hms(seconds_to_period(stop_times))) %>%
  select(-speed,-length,-duration,-route_id)



```

creating the file

```{r creating of the stop_times file, message=FALSE, warning=FALSE}
stop_times <- current_GTFS %>%
  pluck("stop_times") %>%
  slice(0) %>%
  add_row(
    trip_id=stop_times_draft$trip_id,
    stop_id=stop_times_draft$stop_id,
    stop_sequence = stop_times_draft$stop_sequence,
    departure_time=stop_times_draft$stop_times,
    arrival_time=stop_times_draft$stop_times
  )

rm(stop_times_draft)

head(stop_times)
```

# Final Steps

## Minor Edits

After final check, a couple of minor edits are done.

```{r fine tuning, message=FALSE, warning=FALSE}

routes<-routes %>% select(-direction)

trips<-trips_initial %>% mutate(shape_id=route_id)

rm(trips_initial)
```

## Exporting GTFS files

write files

```{r final export, message=FALSE, warning=FALSE}

write_csv(agency,"data/gtfs_20220310/agency.txt")
write_csv(calendar,"data/gtfs_20220310/calendar.txt")
write_csv(routes,"data/gtfs_20220310/routes.txt")
write_csv(shapes,"data/gtfs_20220310/shapes.txt")
write_csv(frequencies,"data/gtfs_20220310/frequencies.txt")
write_csv(stops,"data/gtfs_20220310/stops.txt")
write_csv(stop_times,"data/gtfs_20220310/stop_times.txt")
write_csv(trips,"data/gtfs_20220310/trips.txt")

```



