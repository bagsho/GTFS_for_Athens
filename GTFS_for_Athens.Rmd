---
title: "GTFS Creation for Athens"
author: "Orhan Aktas"
date: '2022-05-19'
output:   
    html_document:
      toc: yes
      number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source = "bg-warning text-warning"
)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidytransit)
library(printr)
library(sf)
library(hms)
library(lubridate)
library(units)
library(zip)
library(jsonlite)
```

# Introduction

In this document, a validated, frequency-based GTFS feed for Athens, Ohio is created from the current informal transit network files. The final output GTFS feed includes the following files that have the required fields.

-   agency.txt

-   stops.txt

-   routes.txt

-   trips.txt

-   stop_times.txt

-   calendar.txt

-   frequencies.txt

-   shapes.txt

# Import data

## Current GTFS data format

```{r import current_GTFS, message=FALSE, warning=FALSE}
current_GTFS <- read_gtfs("data/athens.zip")
names(current_GTFS)
```

```{r}
GTFS_shapes<-current_GTFS[["shapes"]]
GTFS_stop_times<-current_GTFS[["stop_times"]]
GTFS_stops<-current_GTFS[["stops"]]

GTFS_stop_times %>% 
  left_join(GTFS_stops,by="stop_id") %>% 
  select(trip=trip_id,
         seq=stop_sequence,
         time_a=arrival_time,
         time_d=departure_time,
         stop=stop_id,
         stop_name) %>% View
```

## Webpage information

```{r}

stops_link<-"https://athens.doublemap.com/map/v2/stops"
trips_link<-"https://athens.doublemap.com/map/v2/trips"
routes_link<-"https://athens.doublemap.com/map/v2/routes"

web_stops <- fromJSON(stops_link, flatten = TRUE)
web_trips<-fromJSON(trips_link, flatten = TRUE)
web_routes<-fromJSON(routes_link, flatten = TRUE)

rm(stops_link,trips_link,routes_link)

```

# create shapes

```{r shapes}
shapes<-web_routes %>%
  select(id, path) %>%
  as_tibble() %>%
  unnest(cols = path) %>% 
  rename(shape_pt_lat = path,shape_id=id) %>%
  mutate(shape_pt_lon = lead(shape_pt_lat)) %>%
  filter(shape_pt_lon<0)   %>% 
  group_by(shape_id) %>%
  mutate(shape_pt_sequence = as.integer(row_number()-1)) %>% 
  ungroup()
```

similarity with initial GTFS feed

```{r}
source_gtfs_sum <- GTFS_shapes %>%
  group_by(shape_id) %>%
  summarise(count = n()) %>%
  mutate(shape_id = as.integer(shape_id))

shapes %>%
  group_by(shape_id) %>%
  summarise(count = n()) %>%
  left_join(source_gtfs_sum, by = "shape_id")

rm(source_gtfs_sum)
```

It is concluded that although these two files are not same, they are very similar. Therefore for the routes whose path information is missing, it is safe to use the data in the initial GTFS feed. The only missing line is Line4 with the route_id 55.

```{r add missing lines}
final_shapes<-shapes %>% 
  bind_rows(GTFS_shapes %>% 
              mutate(shape_id=as.integer(shape_id)) %>% 
              filter(shape_id==55)
  )
```

# create stops

required fields for stops.txt are the following ones.

-   stop_id

-   stop_name

-   stop_lat

-   stop_lon

Since the there are a lot more stops in the web_stops file than the ones in the initial GTFS stop file, the former one is decided to be used.

```{r}
final_stops<-web_stops %>% 
  as_tibble() %>% 
  select(stop_id=id,
         stop_name=name,
         stop_lat=lat,
         stop_lon=lon) %>% head
```

```{r sample_route_stops}

library(rvest)

text_route_link<-"https://athens.doublemap.com/map/text?route=53"
simple<-read_html(text_route_link)

route_53<-simple %>%
  html_nodes("a") %>% 
  html_attr('href')%>% 
  as_tibble() %>% 
  mutate(value=as.integer(str_replace(value,"text\\?stop=",""))) %>% 
  bind_cols(simple %>%
              html_nodes("a")%>%
              html_text2() %>%  
              as_tibble()
  ) %>% 
  set_names("stop_id","stop_name")%>% 
  mutate(stop_seq=row_number()) %>% 
  relocate(stop_seq)


```

```{r}

```
