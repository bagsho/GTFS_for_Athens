---
title: "GTFS Creation for Athens"
author: "Orhan Aktas"
date: '2022-05-19'
output:   
    html_document:
      toc: yes
      number_sections: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  class.source = "bg-warning text-warning"
)
```

```{r libraries, message=FALSE, warning=FALSE}
library(tidyverse)
library(tidytransit)
library(printr)
library(sf)
library(hms)
library(lubridate)
library(units)
library(zip)
library(jsonlite)
```

# Introduction

In this document, a validated, frequency-based GTFS feed for Athens, Ohio is created from the current informal transit network files. The final output GTFS feed includes the following files that have the required fields.

-   agency.txt

-   stops.txt

-   routes.txt

-   trips.txt

-   stop_times.txt

-   calendar.txt

-   frequencies.txt

-   shapes.txt

# Import data

## Current GTFS data format

```{r import current_GTFS, message=FALSE, warning=FALSE}
current_GTFS <- read_gtfs("data/athens.zip")
names(current_GTFS)
```

```{r}
GTFS_shapes<-current_GTFS[["shapes"]]
GTFS_stop_times<-current_GTFS[["stop_times"]]
GTFS_stops<-current_GTFS[["stops"]]

GTFS_stop_times %>% 
  left_join(GTFS_stops,by="stop_id") %>% 
  select(trip=trip_id,
         seq=stop_sequence,
         time_a=arrival_time,
         time_d=departure_time,
         stop=stop_id,
         stop_name) %>% View
```

## Webpage information

### import web data webpage

The web information was initially imported from web and then saved to a local directory. Then it is imported from that directory every time the code is executed. The reason is that the web information is not stable and all of the routes are not published together all the time. So the routes were imported when all the routes were published.

The code below is the initial one for importing from web and saving to the local directory. It is not executed but left in this file for future uses or investigations.

```{r eval=FALSE, include=FALSE}

stops_link<-"https://athens.doublemap.com/map/v2/stops"
trips_link<-"https://athens.doublemap.com/map/v2/trips"
routes_link<-"https://athens.doublemap.com/map/v2/routes"

web_stops <- fromJSON(stops_link, flatten = TRUE)
web_trips<-fromJSON(trips_link, flatten = TRUE)
web_routes<-fromJSON(routes_link, flatten = TRUE)

web_data<-list(web_stops=web_stops,web_trips=web_trips,web_routes=web_routes)
write_rds(web_data,"data/web_data")

rm(stops_link,trips_link,routes_link,web_data,web_stops,web_routes,web_trips)
```

### import web data from local directory

```{r}
web_stops <- read_rds("data/web_data") %>% pluck("web_stops")
web_trips<-read_rds("data/web_data") %>% pluck("web_trips")
web_routes<-read_rds("data/web_data") %>% pluck("web_routes")
```

# create shapes

```{r shapes}
final_shapes<-web_routes %>%
  select(id, path) %>%
  as_tibble() %>%
  unnest(cols = path) %>% 
  rename(shape_pt_lat = path,shape_id=id) %>%
  mutate(shape_pt_lon = lead(shape_pt_lat)) %>%
  filter(shape_pt_lon<0)   %>% 
  group_by(shape_id) %>%
  mutate(shape_pt_sequence = as.integer(row_number()-1)) %>% 
  ungroup()
```

similarity with initial GTFS feed

```{r}
source_gtfs_sum <- GTFS_shapes %>%
  group_by(shape_id) %>%
  summarise(count = n()) %>%
  mutate(shape_id = as.integer(shape_id))

final_shapes %>%
  group_by(shape_id) %>%
  summarise(count = n()) %>%
  left_join(source_gtfs_sum, by = "shape_id")

rm(source_gtfs_sum)
```

It is concluded that although these two files are not same, they are very similar.

# create stops

required fields for stops.txt are the following ones.

-   stop_id

-   stop_name

-   stop_lat

-   stop_lon

Since there are a lot more stops in the web_stops file than the ones in the initial GTFS stop file, the former one is decided to be used.

```{r}
final_stops<-web_stops %>% 
  as_tibble() %>% 
  select(stop_id=id,
         stop_name=name,
         stop_lat=lat,
         stop_lon=lon)
```

# create routes

the fields that are included in the shapes.txt are the following ones.

-   route_id

-   route_type

-   route_long_name (conditionally)

-   route_short_name (conditionally)

-   route_color (optional)

```{r}
final_routes<-web_routes %>% 
  as_tibble() %>% 
  select(route_id=id,
         route_long_name=name,
         route_short_name=short_name,
         route_color =color
         ) %>% 
  mutate(route_type=3L, # for bus mode
         route_long_name=ifelse(route_id==76,"Line 7n",route_long_name),
         route_long_name=ifelse(route_id==78,"Line 7a",route_long_name),
         route_short_name=ifelse(route_id==76,"7n",route_short_name),
         route_short_name=ifelse(route_id==78,"7a",route_short_name)) 
```

# create stop_times

The stop times will be imported from pdf files so the timetables were initially copied to excel files. However these files are not applicaple directly because the stop names are not same with the stop database. Therefore there should be an initial check before using those timetable data.

-   trip_id

-   arrival_time

-   departure_time

-   stop_id

-   stop_sequence

```{r create input table for timetables}
timetable_input_table<-web_routes %>%
  select(route_id=id, stop_id=stops) %>%
  as_tibble() %>%
  unnest(cols = stop_id) %>% 
  group_by(route_id) %>%
  mutate(stop_sequence = as.integer(row_number()-1)) %>% 
  ungroup() %>% 
  left_join(final_stops,by="stop_id") %>% 
  select(-stop_lat,-stop_lon) %>% 
  left_join(final_routes,by="route_id") %>% 
  select(route_id,route_long_name,stop_sequence,stop_id,stop_name) 

openxlsx::write.xlsx(timetable_input_table,file="data/timetable_input_table.xlsx")


```

# other

this one is not executed.

```{r sample_route_stops, eval=FALSE, include=FALSE}

library(rvest)

text_route_link<-"https://athens.doublemap.com/map/text?route=53"
simple<-read_html(text_route_link)

route_53<-simple %>%
  html_nodes("a") %>% 
  html_attr('href')%>% 
  as_tibble() %>% 
  mutate(value=as.integer(str_replace(value,"text\\?stop=",""))) %>% 
  bind_cols(simple %>%
              html_nodes("a")%>%
              html_text2() %>%  
              as_tibble()
  ) %>% 
  set_names("stop_id","stop_name")%>% 
  mutate(stop_seq=row_number()) %>% 
  relocate(stop_seq)


```

```{r}

```
